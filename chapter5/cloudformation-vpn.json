{
	"AWSTemplateFormatVersion" : "2010-09-09",
	"Description" : "Starts an virtual server (EC2) with OpenSwan acting as VPN IPSec endpoint.",
	"Parameters" : {
		"KeyName": {
			"Description" : "key for SSH access",
			"Type": "AWS::EC2::KeyPair::KeyName",
			"ConstraintDescription" : "Must be the name of an existing key pair."
		},
		"VPC": {
			"Description": "Just select the one and only default VPC",
			"Type": "AWS::EC2::VPC::Id"
		},
		"Subnet": {
			"Description": "Just select one of the available subnets",
			"Type": "AWS::EC2::Subnet::Id"
		},
		"IPSecSharedSecret": {
			"Description": "Just select one of the available subnets",
			"Type": "String"
		},
		"VPNUser": {
			"Description": "Just select one of the available subnets",
			"Type": "String"
		},
		"VPNPassword": {
			"Description": "Just select one of the available subnets",
			"Type": "String"
		}
	},
	"Resources" : {
		"EC2Instance" : {
			"Type" : "AWS::EC2::Instance",
			"Properties" : {
				"InstanceType" : "t2.micro",
				"SecurityGroupIds" : [ { "Ref" : "InstanceSecurityGroup" } ],
				"KeyName" : { "Ref" : "KeyName" },
				"ImageId" : "ami-1ecae776",
				"SubnetId": {"Ref": "Subnet"},
				"UserData" : { "Fn::Base64" : { "Fn::Join" : ["", [
					"#!/bin/bash -xe\n",
					"yum-config-manager --enable epel\n",
					"yum clean all\n",
					"yum update -y aws-cfn-bootstrap\n",
					"export IPSEC_PSK=", { "Ref" : "IPSecSharedSecret" }, "\n",
					"export VPN_USER=", { "Ref" : "VPNUser" }, "\n",
					"export VPN_PASSWORD=", { "Ref" : "VPNPassword" }, "\n",
					"curl https://raw.githubusercontent.com/AWSinAction/code/master/chapter5/setup-vpn.sh | bash\n",
					"/opt/aws/bin/cfn-init -v --stack ", { "Ref" : "AWS::StackName" }, " --resource EC2Instance --region ", { "Ref" : "AWS::Region" }, "\n",
					"/opt/aws/bin/cfn-signal -e $? ", "--stack ", { "Ref" : "AWS::StackName" }, " --resource EC2Instance --region ", { "Ref" : "AWS::Region" }, "\n"					
				]]}}
			},
			"Metadata" : {
				"AWS::CloudFormation::Init" : {
					"config" : {
						"packages" : {
							"yum" : {
								"openswan" : [],
								"xl2tpd" : []
							}
						},
						"services" : {
							"sysvinit" : {
								"ipsec" : {
									"enabled" : "true",
									"ensureRunning" : "true"
								},
								"xl2tpd" : {
									"enabled" : "true",
									"ensureRunning" : "true"
								}
							}
						},
						"files" : {
							"/tmp/setup.mysql" : {
								"content" : { "Fn::Join" : ["", [
									"CREATE DATABASE"
								]]},
								"mode"  : "000644",
								"owner" : "root",
								"group" : "root"
							}
						}
					}
				}
    		}
    	},
		"InstanceSecurityGroup" : {
			"Type" : "AWS::EC2::SecurityGroup",
			"Properties" : {
				"GroupDescription" : "Enable SSH access via port 22",
				"VpcId": {"Ref": "VPC"},
				"SecurityGroupIngress" : [ {
					"IpProtocol" : "-1",
					"FromPort" : "-1",
					"ToPort" : "-1",
					"CidrIp" : "0.0.0.0/0"
				} ]
			}
		}
	},
	"Outputs" : {
		"PublicIP" : {
			"Description" : "Public IP address of the newly created EC2 instance",
			"Value" : { "Fn::GetAtt" : [ "EC2Instance", "PublicIp" ] }
		}
	}
}